<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeniusPost AI</title>
    <link rel="stylesheet" href="../static/index.css"> 
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-animation"></div>
    
    <!-- Floating Particles -->
    <div class="particles" id="particles"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="logo"> GeniusPost AI</h1>
            <p class="tagline">Transform your ideas into engaging LinkedIn posts with AI magic</p>
            {% if current_user.is_authenticated %}
                <div class="profile-container">
                    <img
                    src="{{ current_user.avatar_url }}"
                    alt="Profile"
                    id="profileIcon"
                    class="profile-icon"
                    />
                    <div id="profileCard" class="profile-card">
                    <div class="profile-card-header">
                        Welcome, {{ current_user.name }}
                    </div>
                    <a href="{{ url_for('logout') }}" class="profile-logout-btn">
                        Logout
                    </a>
                    </div>
                </div>
{% endif %}

        </div>

        <!-- Main Content Grid -->
        <div class="main-grid">
            <!-- Input Section -->
            <div class="input-section">
                <h2 class="section-title">Create Your Post</h2>
                <textarea 
                    class="prompt-input" 
                    id="promptInput"
                    placeholder="Describe your LinkedIn post idea... 

Examples:
• Write about the importance of continuous learning in tech
• Share insights about remote work productivity
• Discuss AI trends in marketing
• Create a motivational post about career growth"
                ></textarea>
                
                <!-- <div class="post-options">
                    <button class="option-btn active" data-format="square">
                        📱 Content
                    </button>
                    <button class="option-btn" data-format="vertical">
                        📋 Flowchart
                    </button>
                </div> -->
                
                <button class="generate-btn" id="generateBtn">
                    <span class="btn-text">Generate AI Content</span>
                    <div class="loading-spinner" id="loadingSpinner"></div>
                </button>
            </div>

            <!-- Benefits Section -->
            <div class="benefits-section">
                <h2 class="section-title">Why Choose AI Content?</h2>
                
                <div class="benefit-item">
                    <div class="benefit-icon">⚡</div>
                    <div class="benefit-text">
                        <div class="benefit-title">Lightning Fast</div>
                        <div class="benefit-desc">Generate professional content in seconds</div>
                    </div>
                </div>

                <div class="benefit-item">
                    <div class="benefit-icon">🎯</div>
                    <div class="benefit-text">
                        <div class="benefit-title">Engagement Optimized</div>
                        <div class="benefit-desc">Content designed for maximum LinkedIn reach</div>
                    </div>
                </div>

                <div class="benefit-item">
                    <div class="benefit-icon">✨</div>
                    <div class="benefit-text">
                        <div class="benefit-title">Professional Quality</div>
                        <div class="benefit-desc">AI-powered writing that sounds human</div>
                    </div>
                </div>

                <div class="benefit-item">
                    <div class="benefit-icon">🔄</div>
                    <div class="benefit-text">
                        <div class="benefit-title">Fully Editable</div>
                        <div class="benefit-desc">Customize and refine before posting</div>
                    </div>
                </div>

                <div class="benefit-item">
                    <div class="benefit-icon">💡</div>
                    <div class="benefit-text">
                        <div class="benefit-title">Creative Ideas</div>
                        <div class="benefit-desc">Never run out of content inspiration</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Output Section -->
        <div class="output-section" id="outputSection">
            <h2 class="section-title">Your Generated Content</h2>
            <div class="post-preview">
                <!-- <textarea class="post-content" id="postContent" placeholder="Your generated content will appear here..."></textarea> -->
                <div class="post-content" id="postContent" contenteditable="true" spellcheck="false"></div>

            </div>
            <div class="post-actions">
                <button id="infographicBtn" class="action-btn primary" onclick="copyToClipboard()">📋 Infographic</button>
                <button class="action-btn" id="exportPdfBtn">📄 Export PDF</button>
                <!-- ── INSERT IMAGE BUTTON HERE ── -->
                <button class="action-btn" id="insertImageBtn">🖼️ Insert Image</button>
                <!-- ──────────────────────────────── -->
                <button id="regenerateBtn" class="action-btn" onclick="regenerateContent()">🔄 Regenerate</button>
                <button id="clearBtn" class="action-btn" onclick="clearContent()">🗑️ Clear</button>
            </div>
            <!-- ── HIDDEN FILE INPUT FOR IMAGE UPLOAD ── -->
            <input type="file" id="imageInput" accept="image/*" style="display: none;" />
            <!-- ──────────────────────────────────────── -->
        </div>
    </div>
    <!-- quill library for html editor  -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- html2canvas for image export -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Global variables
        let selectedFormat = 'square';
        let currentPrompt = '';

        // Initialize particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 15) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Post format selection
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedFormat = this.dataset.format;
                });
            });

            // Generate button
            document.getElementById('generateBtn').addEventListener('click', generateContent);

            // Enter key in textarea
            document.getElementById('promptInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    generateContent();
                }
            });
        }

        // Generate content function
        async function generateContent() {
            const promptInput = document.getElementById('promptInput');
            const generateBtn = document.getElementById('generateBtn');
            const btnText = generateBtn.querySelector('.btn-text');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const outputSection = document.getElementById('outputSection');
            const postContent = document.getElementById('postContent');

            currentPrompt = promptInput.value.trim();

            if (!currentPrompt) {
                promptInput.focus();
                promptInput.style.borderColor = '#ff6b6b';
                setTimeout(() => {
                    promptInput.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                }, 2000);
                return;
            }

            // Start loading state
            generateBtn.classList.add('loading');
            btnText.style.display = 'none';
            loadingSpinner.style.display = 'block';

            try {
                // Simulate API call with realistic delay 
                await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 2000));

                const response = await mockApiCall(currentPrompt);
                const markdown_parsed_to_html = marked.parse(response.content);
                postContent.innerHTML = markdown_parsed_to_html // response.content;
                outputSection.classList.add('show');
                outputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                console.error('Error generating content:', error);
                alert('Failed to generate content. Please try again.');
            } finally {
                // End loading state
                generateBtn.classList.remove('loading');
                btnText.style.display = 'block';
                loadingSpinner.style.display = 'none';
            }
        }

        async function mockApiCall(prompt) {
            try {
                const res = await fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
                });

                if (!res.ok) {
                // network/server error (e.g. 500)
                const errText = await res.text();
                throw new Error(`Server responded ${res.status}: ${errText}`);
                }

                const data = await res.json();
                if (data.error) {
                // API-level error
                throw new Error(data.error);
                }

                // Return whatever you need downstream—here, the GPT raw result:
                return { content: data.result };
            } catch (err) {
                // Notify the user
                alert('Error: ' + err.message);

                // Re-throw if you want callers to catch it
                throw err;
            }
            }

            async function copyToClipboard() {
                const preview = document.querySelector('.post-preview');
                if (!preview) {
                    return alert('Nothing to capture!');
                }
                //////////////////////////
                // ── ① TEMPORARILY ADD WATERMARK ──
                const wm = document.createElement('div');
                wm.className = 'watermark';
                wm.innerText = 'GeniusPost AI';
                preview.appendChild(wm);
                //////////////////////////

                // 1. Override heading gradients as before
                const headings = preview.querySelectorAll('h1, h2, h3, h4, h5, h6');
                headings.forEach(h => {
                    h.dataset.origBg    = h.style.background;
                    h.dataset.origClip  = h.style.webkitBackgroundClip;
                    h.dataset.origColor = h.style.color;

                    h.style.background           = 'none';
                    h.style.webkitBackgroundClip = 'unset';
                    h.style.color                = '#fca5a5';
                });

                // 2. Temporarily override the preview background
                const origBg = preview.style.background;
                preview.style.background = 'linear-gradient(135deg, #2a2a3d, #1e1e2f)'; // dark purple–bluish

                // 3. Capture the full preview box
                try {
                    const canvas = await html2canvas(preview, {
                    backgroundColor: null, // let the inline style show
                    scale: 2
                    });
                    canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'linkedin-post.png';
                    a.click();
                    URL.revokeObjectURL(url);
                    });
                } catch (err) {
                    console.error('Snapshot failed:', err);
                    alert('Unable to save snapshot.');
                }

                // 4. Restore original heading and preview background styles
                headings.forEach(h => {
                    h.style.background           = h.dataset.origBg;
                    h.style.webkitBackgroundClip = h.dataset.origClip;
                    h.style.color                = h.dataset.origColor;
                    delete h.dataset.origBg;
                    delete h.dataset.origClip;
                    delete h.dataset.origColor;
                });
                preview.style.background = origBg;
                // ── ④ REMOVE WATERMARK ──
                preview.removeChild(wm);
                }
// /////////////////////////////// PDF ////////////////////////////////////////////////////////////
        
            document.getElementById('exportPdfBtn').addEventListener('click', async () => {
            const preview = document.querySelector('.post-preview');
            if (!preview) return alert('Nothing to export!');
            // ── ① TEMPORARILY ADD WATERMARK ──
            const wm = document.createElement('div');
            wm.className = 'watermark';
            wm.innerText = 'GeniusPost AI';
            preview.appendChild(wm);

            // Temporarily override heading gradients (same as PNG fix)
            const headings = preview.querySelectorAll('h1, h2, h3, h4, h5, h6');
            headings.forEach(h => {
                h.dataset.origBg    = h.style.background;
                h.dataset.origClip  = h.style.webkitBackgroundClip;
                h.dataset.origColor = h.style.color;
                h.style.background           = 'none';
                h.style.webkitBackgroundClip = 'unset';
                h.style.color                = '#fca5a5';
            });

            // Temporarily darken background if needed
            const origBg = preview.style.background;
            preview.style.background = 'linear-gradient(135deg, #2a2a3d, #1e1e2f)';

            try {
                // 1. Render the entire preview to one tall canvas
                const canvas = await html2canvas(preview, { backgroundColor: null, scale: 2 });
                


                // 2. Export as PNG for perfect fidelity
                const imgData = canvas.toDataURL('image/png');

                // --- NEW: crop the tall canvas into A4‐sized page slices ---
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ unit: 'px', format: 'a4' });
                const pdfW = pdf.internal.pageSize.getWidth();
                const pdfH = pdf.internal.pageSize.getHeight();

                // Compute the ratio of canvas→PDF widths
                const canvasW = canvas.width;
                const canvasH = canvas.height;
                const scale = (pdfW - 40) / canvasW; 
                const pageCanvasH = Math.floor(pdfH / scale);

                let renderedH = 0;
                while (renderedH < canvasH) {
                    // 5. Fill entire page with neon purple (or black). 
                    //    RGB for neon‐purple (#9f7aea) = (159, 122, 234).
                    pdf.setFillColor(159, 122, 234);
                    pdf.rect(0, 0, pdfW, pdfH, 'F');
                // Create a temp canvas for this page
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvasW;
                tempCanvas.height = Math.min(pageCanvasH, canvasH - renderedH);
                const tCtx = tempCanvas.getContext('2d');
                
                // Draw the slice
                tCtx.drawImage(
                    canvas,
                    0, renderedH,               // src x, y
                    canvasW, tempCanvas.height, // src w, h
                    0, 0,
                    canvasW, tempCanvas.height  // dst w, h
                );
                
                // Add to PDF
                const sliceData = tempCanvas.toDataURL('image/jpeg', 0.8);
                // pdf.addImage(sliceData, 'PNG', 20, 20, canvasW * scale, tempCanvas.height * scale);
                pdf.addImage(sliceData, 'JPEG', 20, 20, canvasW * scale, tempCanvas.height * scale);
                renderedH += pageCanvasH;
                if (renderedH < canvasH) pdf.addPage();
                }

                pdf.save('linkedin-post.pdf');

            } catch (e) {
                console.error('PDF export failed:', e);
                alert('Could not export multi-page PDF.');
            } finally {
                // ── ④ REMOVE WATERMARK ──
                preview.removeChild(wm);
                // Restore heading and preview bg
                headings.forEach(h => {
                h.style.background           = h.dataset.origBg;
                h.style.webkitBackgroundClip = h.dataset.origClip;
                h.style.color                = h.dataset.origColor;
                delete h.dataset.origBg;
                delete h.dataset.origClip;
                delete h.dataset.origColor;
                });
                preview.style.background = origBg;
            }
            });

            

        // ///////////////////////////////////////////////////////////////////////////////////////
                function regenerateContent() {
                    if (currentPrompt) {
                        generateContent();
                    }
                }

                function clearContent() {
                    document.getElementById('postContent').value = '';
                    document.getElementById('outputSection').classList.remove('show');
                    document.getElementById('promptInput').value = '';
                    currentPrompt = '';
                }

                // Initialize everything when DOM loads
                document.addEventListener('DOMContentLoaded', function() {
                    createParticles();
                    initializeEventListeners();
                });

                // Add some interactive hover effects
                document.addEventListener('mousemove', function(e) {
                    const particles = document.querySelectorAll('.particle');
                    particles.forEach(particle => {
                        const speed = Math.random() * 2 + 1;
                        const x = (e.clientX * speed) / 100;
                        const y = (e.clientY * speed) / 100;
                        
                        particle.style.transform = `translateX(${x}px) translateY(${y}px)`;
                    });
                });

    ////////////////////////////////////Image/////////////////////////////////
        document
      .getElementById('insertImageBtn')
      .addEventListener('click', () => {
        document.getElementById('imageInput').click();
    });

    document
      .getElementById('imageInput')
      .addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) {
          alert('Please select an image file.');
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          const imgDataUrl = reader.result;
          const img = document.createElement('img');
          img.src = imgDataUrl;
          img.style.maxWidth = '100%';
          img.style.margin = '1rem 0';
          img.style.borderRadius = '0.75rem';
          img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
          
          const postDiv = document.getElementById('postContent');
          postDiv.appendChild(img);
          postDiv.appendChild(document.createElement('br'));
          event.target.value = '';
        };
        reader.readAsDataURL(file);
    });

    document.addEventListener('DOMContentLoaded', () => {
    const icon = document.getElementById('profileIcon');
    const card = document.getElementById('profileCard');
    if (!icon || !card) return;

    icon.addEventListener('click', e => {
      e.stopPropagation();
      card.classList.toggle('visible');
    });

    // click outside closes the card
    document.addEventListener('click', () => {
      card.classList.remove('visible');
    });

    // prevent clicks inside the card from bubbling out
    card.addEventListener('click', e => e.stopPropagation());
  });

  function trackAction(action) {
    fetch("/track_action", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",    // so Flask-Login cookie is sent
        body: JSON.stringify({ action })
    }).catch(console.error);
    }

    // map IDs → action strings
    const mapping = {
    generateBtn:    "generate_ai_content",
    infographicBtn: "infographic",
    exportPdfBtn:   "export_pdf",
    insertImageBtn:   "insert_image",
    regenerateBtn:  "regenerate",
    clearBtn:       "clear",
    };

    Object.entries(mapping).forEach(([id, action]) => {
    const btn = document.getElementById(id);
    if (btn) btn.addEventListener("click", () => trackAction(action));
    });

    </script>
</body>
</html>